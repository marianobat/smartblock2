<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartBlock Web — Cloud Agent</title>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Blockly -->
  <script src="https://unpkg.com/blockly@10.4.3/blockly.min.js" defer></script>
  <script src="https://unpkg.com/blockly@10.4.3/blocks.min.js" defer></script>
  <script src="https://unpkg.com/blockly@10.4.3/msg/es.js" defer></script>

  <!-- Archivos propios -->
  <script src="./blocks.js" defer></script>
  <script src="./generator.js" defer></script>
  <script src="./app.js" defer></script>
</head>

<body>
  <header>
    <div class="brand">
      <figure class="brand-media" data-placeholder="SB">
        <img src="./assets/brand-logo.svg" alt="Logotipo SmartBlock" id="brandLogo" class="brand-logo" />
      </figure>
      <div class="brand-copy">
        <h1>SmartBlock <span class="tag">web</span></h1>
        <p class="subtitle">Bloques → C++ → Export .ino · Conexión vía Cloud Agent</p>
      </div>
    </div>
    <div class="actions">
      <button id="btn-generate">Generar código</button>
      <button id="btn-download">Descargar .ino</button>
      <button id="btn-test-led">Test LED13 (on/off)</button>
    </div>
  </header>

  <main>
    <section id="left">
      <div id="blocklyDiv"></div>

      <xml id="toolbox" style="display:none">
        <category name="⚙️ Control" categorystyle="loop_category">
          <block type="controls_repeat_ext">
            <value name="TIMES">
              <shadow type="math_number">
                <field name="NUM">4</field>
              </shadow>
            </value>
          </block>
          <block type="controls_if"></block>
          <block type="delay_ms"></block>
        </category>

        <category name="🧠 Lógica" categorystyle="logic_category">
          <block type="logic_compare"></block>
          <block type="logic_boolean"></block>
          <block type="math_number"></block>
        </category>

        <category name="🔌 Actuadores" categorystyle="io_category">
          <block type="digital_write_pin"></block>
        </category>

        <category name="📟 Displays" categorystyle="display_category">
          <block type="display_lcd_print"></block>
          <block type="display_lcd_clear"></block>
          <block type="display_matrix_pattern"></block>
        </category>

        <category name="📈 Sensores" categorystyle="sensor_category">
          <block type="analog_read_pin"></block>
          <block type="sensor_button_read"></block>
          <block type="sensor_soil_moisture"></block>
          <block type="sensor_dht11_value"></block>
        </category>

        <category name="⚙️ Motores" categorystyle="motor_category">
          <block type="motor_dc_speed">
            <value name="SPEED">
              <shadow type="math_number">
                <field name="NUM">180</field>
              </shadow>
            </value>
          </block>
          <block type="motor_servo_write">
            <value name="ANGLE">
              <shadow type="math_number">
                <field name="NUM">90</field>
              </shadow>
            </value>
          </block>
        </category>
      </xml>
    </section>

    <div id="codeSplitter" class="code-splitter" role="separator" aria-orientation="vertical" aria-controls="codePaneBody">
      <button id="codeToggle" class="code-pane-toggle" type="button" aria-expanded="true">
        <span class="icon">◀</span>
        <span class="label">Ocultar</span>
      </button>
    </div>

    <section id="right" class="code-pane">
      <div id="codePaneBody" class="code-pane-content" role="region" aria-label="Sketch generado">
        <header class="code-pane-header">
          <h3>Sketch (.ino)</h3>
          <div class="code-actions">
            <span id="code-status" class="badge badge-muted">Auto</span>
            <button id="code-copy" type="button">Copiar</button>
          </div>
        </header>
        <pre id="code"></pre>
      </div>
    </section>
  </main>

  <footer>
    <small>SmartBlock Web Starter · Integración Cloud Agent · MIT</small>
  </footer>

  <!-- Panel simplificado de conexión y subida -->
  <section id="agent-panel">
    <div class="agent-header">
      <h2>Subir a la placa</h2>
      <div class="agent-header-status">
        <span id="uploader-status" class="badge warn">Buscando uploader…</span>
        <span id="uploader-endpoint" class="endpoint-label">—</span>
      </div>
    </div>

    <div class="agent-steps">
      <article id="upload-step-detect" class="step-card" data-state="searching">
        <header class="step-head">
          <span class="step-index">1</span>
          <div>
            <h3>Detectar uploader local</h3>
            <p class="step-description">Necesitamos encontrar el agente que sube el sketch desde tu computadora.</p>
          </div>
        </header>
        <div class="step-body">
          <p id="uploader-status-detail" class="step-status-text warn">Buscando uploader…</p>
        </div>
        <footer class="step-actions">
          <button id="btnRetryUploader" type="button" class="ghost small">Reintentar detección</button>
        </footer>
      </article>

      <article id="upload-step-agent" class="step-card">
        <header class="step-head">
          <span class="step-index">2</span>
          <div>
            <h3>Conectar Arduino Cloud Agent</h3>
            <p class="step-description">Conectá el Agent para listar puertos disponibles y mantener la conexión viva.</p>
          </div>
        </header>
        <div class="step-body">
          <span id="agentStatus" class="badge warn">Sin conexión</span>
          <div class="step-buttons">
            <button id="btnConnect" class="primary">Conectar Agent</button>
            <button id="btnRefreshPorts" class="ghost">Actualizar puertos</button>
          </div>
        </div>
      </article>

      <article id="upload-step-upload" class="step-card">
        <header class="step-head">
          <span class="step-index">3</span>
          <div>
            <h3>Elegir placa y subir</h3>
            <p class="step-description">Seleccioná el puerto y modelo antes de enviar tu sketch compilado.</p>
          </div>
        </header>
        <div class="step-body">
          <label class="field">
            <span>Puerto</span>
            <select id="portSelect"></select>
          </label>
          <label class="field">
            <span>Modelo</span>
            <select id="fqbnSelect">
              <option value="arduino:avr:nano" selected>Arduino Nano (Optiboot)</option>
              <option value="arduino:avr:nano:cpu=atmega328old">Arduino Nano (Bootloader viejo)</option>
              <option value="arduino:avr:uno">Arduino UNO</option>
            </select>
          </label>
          <button id="btnUploadCli" type="button" class="primary is-disabled" disabled>Subir programa</button>
          <div id="uploadProgress" class="inline-progress hidden">
            <progress id="uploadProgressBar" max="100" value="0"></progress>
            <p id="uploadProgressText">Preparando…</p>
          </div>
        </div>
      </article>
    </div>

    <div class="agent-log">
      <h3>Actividad</h3>
      <pre id="log"></pre>
    </div>
  </section>

  <!-- Cliente Socket.IO (v2.x) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.4.0/socket.io.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Integración Cloud Agent -->
  <script src="./agent.js"></script>
  <script src="./serial-ui.js"></script>
</body>
</html>
